#!/bin/env groovy

// Check remote host properties
//    disableConcurrentBuilds()

properties([

    parameters([
	string(name: 'myvar1', description: 'Make BUILD stage?', defaultValue: 'make'),
	string(name: 'myvar2', description: 'Example of parameter', defaultValue: '22222')
		])
	])

def build_status = params.myvar1
println params.myvar1.getClass()

pipeline {
    agent { 
        label 'server'
        }
    options {
        buildDiscarder(logRotator(numToKeepStr: '10', artifactNumToKeepStr: '10'))
        timestamps()
    }

    environment {
	dockerImage = ''
	REGISTRY = "nixuss/test:app"
//	dockerHubCredential = '...'
    }

    stages {
        stage("PREPARE") {
            steps {
                sh 'echo Cleaning workspace'
                cleanWs()
            }
        }

	stage("Git clone") {
		steps {
		git branch: 'branch2', changelog: 'false', credentialsId: 'jenkins-container-privkey', url: 'git@github.com:nixuss/test.git'		
		}		
	}

        stage("Info step") {
            steps {
                sh 'pwd'
		sh 'id'
		sh 'ls'
		sh 'echo ${params.var1}'
		sh 'echo ${build_status}'
            }
        }

	stage("BUILD") {
	    when {
		expression {
		    params.var1 == 'make'              
		}	            
	    }
	    steps {
		script {
		    dockerImage = docker.build REGISTRY	
			}	
		}		
	}

        stage("CLEAN") {
            steps {
                sh 'echo Cleaning workspace'
                cleanWs()
            }
        }

    }
}
